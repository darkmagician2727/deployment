<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Ranking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
        }

        .song {
            margin-bottom: 10px;
        }

        .button-container {
            text-align: center;
            margin-top: 20px;
        }

        button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .ranking-input {
            width: 100%;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Song Ranking</h2>
    <div id="songContainer"></div>
    <div class="button-container">
        <button onclick="rankAlbums()">Rank Albums</button>
        <button onclick="startTournament()">Start Song Tournament</button>
        <button onclick="viewRanking()">View Final Ranking</button>
    </div>
</div>

<script>
    const albums = Array.from({ length: 10 }, (_, index) => ({ id: index + 1, name: `Album ${index + 1}` }));
    const songs = Array.from({ length: 300 }, (_, index) => ({ id: index + 1, name: `Song ${index + 1}`, albumId: Math.ceil((index + 1) / 30) }));
    const albumRankingsKey = 'albumRankings';
    const songRankingsKey = 'songRankings';

    function initializeAlbumRankings() {
        const albumRankings = {};
        albums.forEach(album => {
            albumRankings[album.id] = 0;
        });
        localStorage.setItem(albumRankingsKey, JSON.stringify(albumRankings));
    }

    function rankAlbums() {
        initializeAlbumRankings();
        const albumRankings = JSON.parse(localStorage.getItem(albumRankingsKey));
        const albumsContainer = document.getElementById('songContainer');
        albumsContainer.innerHTML = '<h3>Rank Albums</h3>';

        albums.forEach(album => {
            const albumDiv = document.createElement('div');
            albumDiv.classList.add('song');
            albumDiv.innerHTML = `<label>${album.name}</label>
                                  <input class="ranking-input" type="number" min="1" max="${albums.length}" placeholder="1-${albums.length}" />`;
            albumsContainer.appendChild(albumDiv);
        });

        const rankButton = document.createElement('button');
        rankButton.textContent = 'Submit Rankings';
        rankButton.onclick = function() {
            const inputs = document.querySelectorAll('.ranking-input');
            inputs.forEach((input, index) => {
                albumRankings[albums[index].id] = parseInt(input.value);
            });
            localStorage.setItem(albumRankingsKey, JSON.stringify(albumRankings));
            alert('Album ranking completed.');
        };

        albumsContainer.appendChild(rankButton);
    }

    function initializeSongRankings() {
        const songRankings = {};
        songs.forEach(song => {
            songRankings[song.id] = { mmr: 1000 }; // Initial MMR
        });
        localStorage.setItem(songRankingsKey, JSON.stringify(songRankings));
    }

    function generatePairings() {
        const pairings = [];
        for (let i = 0; i < songs.length; i += 4) {
            pairings.push({ songs: songs.slice(i, i + 4) });
        }
        return pairings;
    }

    function getUserPreference(pairing) {
        const songsContainer = document.getElementById('songContainer');
        songsContainer.innerHTML = '<h3>Rank Songs</h3>';
        pairing.songs.forEach(song => {
            const songDiv = document.createElement('div');
            songDiv.classList.add('song');
            songDiv.innerHTML = `<label>${song.name}</label>
                                  <input class="ranking-input" type="number" min="1" max="${pairing.songs.length}" placeholder="1-${pairing.songs.length}" />`;
            songsContainer.appendChild(songDiv);
        });

        const rankButton = document.createElement('button');
        rankButton.textContent = 'Submit Rankings';
        rankButton.onclick = function() {
            const inputs = document.querySelectorAll('.ranking-input');
            const preferences = [];
            inputs.forEach(input => {
                preferences.push(parseInt(input.value));
            });
            updateRankings(pairing, preferences);
        };

        songsContainer.appendChild(rankButton);
    }

    function updateRankings(pairing, preferences) {
        const songRankings = JSON.parse(localStorage.getItem(songRankingsKey));
        pairing.songs.forEach((song, songIndex) => {
            const preference = preferences[songIndex];
            const expectedOutcome = 1 / (1 + 10 ** ((pairing.songs[1].mmr - song.mmr) / 400));
            const outcome = preference < pairing.songs.length ? 1 : 0;
            const k = 32; // Adjustment factor

            songRankings[song.id].mmr += k * (outcome - expectedOutcome);
        });
        localStorage.setItem(songRankingsKey, JSON.stringify(songRankings));
        alert('Song rankings updated.');
    }

    function startTournament() {
        initializeSongRankings();
        const pairings = generatePairings();
        pairings.forEach(pairing => getUserPreference(pairing));
    }

    function viewRanking() {
        const songRankings = JSON.parse(localStorage.getItem(songRankingsKey));
        const sortedRankings = Object.entries(songRankings).sort((a, b) => b[1].mmr - a[1].mmr);
        
        const songContainer = document.getElementById('songContainer');
        songContainer.innerHTML = '<h3>Final Song Ranking</h3>';

        sortedRankings.forEach((entry, index) => {
            const [songId, { mmr }] = entry;
            const song = songs.find(s => s.id === parseInt(songId));
            const rank = index + 1;
            const songDiv = document.createElement('div');
            songDiv.classList.add('song');
            songDiv.textContent = `${rank}. ${song.name} (Album ${song.albumId}) - MMR: ${mmr.toFixed(2)}`;
            songContainer.appendChild(songDiv);
        });
    }
</script>

</body>
</html>
